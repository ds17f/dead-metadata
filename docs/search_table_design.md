# Search Tables Design Document

## Overview
This document outlines the design for denormalized search tables that will enable fast mobile app searches across songs, venues, dates, and band members for the Grateful Dead show database.

## Data Architecture Overview

The search system uses a **two-tier architecture**:

1. **Search Tables** (`stage03-search-data/`): Lightweight index tables optimized for fast searching
2. **Primary Show Data** (existing): Complete show details for individual display

### Data Flow: Search → Detail
```
User searches "dark star fillmore" 
  ↓ 
Search tables return matching show_ids with basic context
  ↓
App displays search results list (show date, venue, rating)
  ↓
User taps on "1969-02-27-fillmore-west-san-francisco-ca-usa"
  ↓
App loads complete show data file for full details (setlist, band, recordings)
```

**Key Benefit**: Search tables stay lean (~4MB total) while preserving all rich show detail in the primary data files.

## Problem Statement
The current show data is optimized for individual show display but not for search. Users want to search for:
- **Songs**: "What shows played 'Estimated Prophet'?"
- **Venues**: "What shows were at the Fillmore?"
- **Members**: "What shows had Keith Godchaux?"
- **Dates**: "Shows in 1977" or "Shows in May"
- **Combined**: "Dark Star at Winterland in 1973"

## Solution: Denormalized Search Tables

### Target Search Tables Structure

#### 1. Songs Table (`songs.json`)
**Purpose**: Fast lookup of which shows played specific songs  
**Usage**: Search results include basic show context, detailed setlist comes from primary show data

```json
{
  "estimated-prophet": {
    "name": "Estimated Prophet",
    "shows": [
      {
        "show_id": "1977-05-08-barton-hall-cornell-u-ithaca-ny-usa",
        "date": "1977-05-08",
        "venue": "Barton Hall, Cornell University",
        "location": "Ithaca, NY, USA",
        "set": "Set 2",
        "position": 3,
        "segue_into_next": false,
        "rating": 2.37,
        "raw_rating": 4.74
      }
    ],
    "total_performances": 145,
    "first_performance": "1977-03-18",
    "last_performance": "1995-07-09",
    "aliases": ["estimated", "prophet", "estimated-prophet"]
  }
}
```

#### 2. Venues Table (`venues.json`)
**Purpose**: Fast lookup of shows at specific venues  
**Usage**: Search results provide show list, complete show details loaded separately

```json
{
  "barton-hall-cornell-university": {
    "name": "Barton Hall, Cornell University",
    "location": "Ithaca, NY, USA",
    "city": "Ithaca",
    "state": "NY",
    "country": "USA",
    "shows": [
      {
        "show_id": "1977-05-08-barton-hall-cornell-u-ithaca-ny-usa",
        "date": "1977-05-08",
        "rating": 2.37,
        "raw_rating": 4.74,
        "recording_count": 23
      }
    ],
    "total_shows": 1,
    "first_show": "1977-05-08",
    "last_show": "1977-05-08",
    "aliases": ["barton-hall", "cornell-university", "cornell", "barton-hall-cornell"]
  }
}
```

#### 3. Band Members Table (`members.json`)
**Purpose**: Fast lookup of shows featuring specific band members  
**Usage**: Search results show member participation, complete band lineup in primary show data

```json
{
  "jerry-garcia": {
    "name": "Jerry Garcia",
    "instruments": ["guitar", "vocals"],
    "shows": [
      {
        "show_id": "1977-05-08-barton-hall-cornell-u-ithaca-ny-usa",
        "date": "1977-05-08",
        "venue": "Barton Hall, Cornell University",
        "instruments": "guitar, vocals",
        "rating": 2.37
      }
    ],
    "total_shows": 2200,
    "first_show": "1965-12-04",
    "last_show": "1995-07-09",
    "primary_instruments": ["guitar", "vocals"],
    "aliases": ["jerry", "garcia", "jerry-garcia", "captain-trips"]
  }
}
```

#### 4. Shows Index (`shows_index.json`)
**Purpose**: Fast lookup by date, year, location for filtering  
**Usage**: Supports date-based searches, full show details in primary data files

```json
{
  "1977-05-08-barton-hall-cornell-u-ithaca-ny-usa": {
    "show_id": "1977-05-08-barton-hall-cornell-u-ithaca-ny-usa",
    "date": "1977-05-08",
    "venue": "Barton Hall, Cornell University",
    "location": "Ithaca, NY, USA",
    "city": "Ithaca",
    "state": "NY",
    "country": "USA",
    "band": "Grateful Dead",
    "year": 1977,
    "month": 5,
    "day": 8,
    "rating": 2.37,
    "raw_rating": 4.74,
    "recording_count": 23,
    "song_count": 15,
    "has_setlist": true,
    "search_text": "1977 may barton hall cornell ithaca ny usa grateful dead"
  }
}
```

## Primary Show Data Integration

### Existing Show Data Structure
The search tables reference existing show files generated by `integrate_jerry_garcia_shows.py`:

```
stage02-processed-data/shows/
├── 1965-12-04-magoos-pizza-parlor-menlo-park-ca-usa.json
├── 1977-05-08-barton-hall-cornell-u-ithaca-ny-usa.json
└── ... (2,200+ show files)
```

### Complete Show Data Contains
- **Complete setlist**: All songs with set positions, segues, encore information
- **Band lineup**: All members with instruments and roles
- **Venue details**: Complete venue information with address/location data
- **Recording information**: Archive.org ratings, recording counts, source types
- **Show metadata**: Date, band configuration, supporting acts, notes

### App Integration Pattern
```javascript
// 1. Search returns show_ids with basic context
const searchResults = searchSongs("estimated prophet");
// Results: [{ show_id: "1977-05-08-barton-hall...", date: "1977-05-08", venue: "Barton Hall" }]

// 2. Display search results list using basic context

// 3. User selects show → Load complete show data
const showDetails = await loadShowData("1977-05-08-barton-hall-cornell-u-ithaca-ny-usa");
// Returns: complete setlist, band lineup, all recordings, venue details, etc.
```

## Normalization Strategy

### Text Normalization Pipeline
1. **Basic Cleaning**:
   - Convert to lowercase
   - Remove punctuation except hyphens
   - Normalize whitespace
   - Convert spaces to hyphens for keys

2. **Data-Driven Alias Discovery**:
   - Scan all song names to find natural variations
   - Identify venue name patterns and abbreviations
   - Extract member name components (first, last, nicknames)

3. **Knowledge-Based Aliases**:
   - Grateful Dead-specific song variations
   - Common venue abbreviations
   - Historical member nicknames
   - Location aliases (SF, NYC, etc.)

### Alias Generation Examples

#### Songs (Data + Knowledge)
```python
# Data-driven: Found in actual setlists
"Saint Stephen" → ["saint-stephen", "st-stephen"]
"They Love Each Other" → ["they-love-each-other", "tleo"]

# Knowledge-based: Known Dead variations
"Dark Star" → ["dark-star", "darkstar", "ds"]
"Playing in the Band" → ["playing-in-the-band", "pitb", "playing"]
```

#### Venues (Data + Knowledge)
```python
# Data-driven: Multiple name formats found
"Fillmore West" → ["fillmore-west", "fillmore", "sf-fillmore"]
"Winterland Arena" → ["winterland-arena", "winterland"]

# Knowledge-based: Common abbreviations
"Madison Square Garden" → ["msg", "madison-square-garden", "garden"]
"Red Rocks Amphitheatre" → ["red-rocks", "red-rocks-amphitheatre"]
```

#### Members (Data + Knowledge)
```python
# Data-driven: Name component analysis
"Jerry Garcia" → ["jerry-garcia", "jerry", "garcia"]
"Bob Weir" → ["bob-weir", "bob", "weir"]

# Knowledge-based: Known nicknames
"Jerry Garcia" → [..., "captain-trips"]
"Phil Lesh" → [..., "phil", "lesh"]
```

## Mobile App Search Usage

### Search Algorithm Flow
```javascript
function searchAllTables(query) {
    const normalizedQuery = normalizeSearchText(query);
    
    // Search each table for matches
    const songMatches = searchSongs(normalizedQuery);
    const venueMatches = searchVenues(normalizedQuery);
    const memberMatches = searchMembers(normalizedQuery);
    const dateMatches = searchDates(normalizedQuery);
    
    // Collect unique show_ids with relevance scores
    const allMatches = [
        ...songMatches.map(m => ({...m, type: 'song', relevance: 10})),
        ...venueMatches.map(m => ({...m, type: 'venue', relevance: 8})),
        ...memberMatches.map(m => ({...m, type: 'member', relevance: 6})),
        ...dateMatches.map(m => ({...m, type: 'date', relevance: 4}))
    ];
    
    // Group by show_id, combine relevance, sort by date
    return combineAndSortResults(allMatches);
}
```

### Example Search Scenarios

#### Single Term: "dark star"
- **Songs**: Direct match → 200+ shows
- **Venues**: No matches
- **Members**: No matches
- **Result**: All shows that played Dark Star

#### Venue: "fillmore"
- **Songs**: No matches
- **Venues**: "fillmore-west" + "fillmore-east" → 150+ shows
- **Members**: No matches
- **Result**: All Fillmore shows

#### Combined: "dark star fillmore 1969"
- **Songs**: "dark star" → 200+ shows
- **Venues**: "fillmore" → 150+ shows
- **Dates**: "1969" → 100+ shows
- **Result**: Intersection → Dark Star at Fillmore in 1969 (5-10 shows)

## Implementation Plan

### Development Phase: Data Analysis (One-time)
Create `scripts/03-search-data/analyze_search_data.py` as a **development tool** to:
- Scan all shows and extract unique songs/venues/members
- Identify natural variations and patterns  
- Generate statistics and discover common aliases
- Output analysis report to inform normalization rules

**Usage**: Run manually during development to build normalization logic, not part of production pipeline.

### Production Phase: Search Table Generation
Create `scripts/03-search-data/generate_search_tables.py` to:
- Process all show files into denormalized tables
- Apply hard-coded normalization and alias rules (based on analysis findings)
- Create optimized JSON files for mobile consumption
- Validate data integrity and completeness

### Pipeline Integration
Add to Makefile:
```makefile
# Stage 3: Search Data Generation
generate-search-tables:
	python scripts/03-search-data/generate_search_tables.py --verbose

stage03-search-data: generate-search-tables
	@echo "🔍 Stage 3: Search data generation complete!"

all: stage01-collect-data stage02-generate-data stage03-search-data

# Development tools (run manually as needed)
analyze-search-data:
	python scripts/03-search-data/analyze_search_data.py --verbose
```

## Data Files & Integration

### Search Tables Output (`stage03-search-data/`)
- `songs.json` (~2-3MB) - Song-to-shows index
- `venues.json` (~500KB) - Venue-to-shows index  
- `members.json` (~200KB) - Member-to-shows index
- `shows_index.json` (~1MB) - Date/location search index

### Primary Show Data (existing `stage02-processed-data/shows/`)
- Individual JSON files per show (~2,200 files)
- Complete show details for app display
- Referenced by show_id from search tables

### App Bundle Strategy
```
data.zip contains:
├── search/
│   ├── songs.json      # Search index tables
│   ├── venues.json
│   ├── members.json
│   └── shows_index.json
└── shows/
    ├── 1965-12-04-magoos-pizza-parlor-menlo-park-ca-usa.json  # Complete show data
    ├── 1977-05-08-barton-hall-cornell-u-ithaca-ny-usa.json
    └── ... (2,200+ files)
```

**Total Bundle Size**: ~6-8MB (4MB search tables + 2-4MB show data)

## Benefits

1. **Performance**: Pre-computed search data eliminates runtime processing
2. **Unified Search**: Single interface across all search dimensions  
3. **Rich Results**: Each match includes ratings, dates, context
4. **Mobile Optimized**: Compact JSON perfect for app caching
5. **Flexible**: Supports exact, prefix, and multi-term searches
6. **Scalable**: Easy to add new search dimensions or data sources
7. **Separation of Concerns**: Lean search tables + rich detail files

## Future Enhancements

- **Full-text search**: Add song lyrics, show notes, review text
- **Fuzzy matching**: Handle typos and phonetic similarities  
- **Relevance ranking**: ML-based result scoring
- **Caching**: Smart client-side caching strategies
- **Analytics**: Track popular searches to optimize data structure